<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>visio 2.0</title>
</head>
<body>
<div id="container" style="width: 960px; margin: 0 auto">
<video width="960" controls autoplay id="player"></video>
</div>
<script type="text/javascript" src="jmuxer.min.js"></script>
<script>
function concatTypedArrays(a, b) { // a, b TypedArray of same type
    var c = new (a.constructor)(a.length + b.length);
    c.set(a, 0);
    c.set(b, a.length);
    return c;
}
function concatBuffers(a, b) {
    return concatTypedArrays(
        new Uint8Array(a.buffer || a), 
        new Uint8Array(b.buffer || b)
    ).buffer;
}
function concatBytes(ui8a, byte) {
    var b = new Uint8Array(1);
    b[0] = byte;
    return concatTypedArrays(ui8a, b);
}

function parse(data) {
      var input = new Uint8Array(data),
          dv = new DataView(input.buffer),
          duration,
          audioLength,
          audio,
          video;

      duration = dv.getUint16(0, true);
      audioLength = dv.getUint16(2, true);
      audio = input.subarray(4, (audioLength + 4));
      video = input.subarray(audioLength + 4);

      return {
        audio: audio,
        video: video,
        duration: duration
      };
}

var separator = new Uint8Array([0, 0, 0, 1])
var aseparator = new Uint8Array([255, 241])

var h264buffer = new Uint8Array();
var audiobuffer = new Uint8Array();
var time = +new Date;
var atime = +new Date;

    var socketURL = 'ws://'+window.location.hostname+':8081';
    var jmuxer = new JMuxer({
        node: 'player',
        mode: 'video',
        //flushingTime: 1,
        clearBuffer: false,
        fps: 29.97,
        debug: false
     });

     var ws = new WebSocket(socketURL);
     ws.binaryType = 'arraybuffer';
     ws.addEventListener('message',function(event) {
         //console.log('video '+((+new Date)-time));
         time = +new Date;
         if(document.visibilityState == 'visible') h264buffer = concatTypedArrays(h264buffer, concatTypedArrays(separator, new Uint8Array(event.data)));
     });
     var inter = setInterval(function() {
          if(document.visibilityState == 'visible' && h264buffer.length > 0) jmuxer.feed({video: h264buffer});
          h264buffer = new Uint8Array();
     }, 200);

     var aws = new WebSocket('ws://'+window.location.hostname+':8082');
     aws.binaryType = 'arraybuffer';
     aws.addEventListener('message',function(event) {
         //console.log('audio '+((+new Date)-atime));
         atime = +new Date;
         audiobuffer = concatTypedArrays(audiobuffer, concatTypedArrays(aseparator, new Uint8Array(event.data)));
         //jmuxer.feed({video: concatTypedArrays(separator, new Uint8Array(event.data))});
     });
     var inter2 = setInterval(function() {
          jmuxer.feed({audio: audiobuffer});
          audiobuffer = new Uint8Array();
     }, 500);
</script>
</body>
</html>
